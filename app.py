import streamlit as st
import pandas as pd
import urllib.parse

# --- APP CONFIG ---
st.set_page_config(page_title="Mishra Market Admin", layout="wide")

# --- SHOP LIST (рдЖрдкрдХреА рдкреВрд░реА рджреБрдХрд╛рдиреЛрдВ рдХреА рд▓рд┐рд╕реНрдЯ рдпрд╣рд╛рдБ рд╣реИ) ---
SHOPS = [
    "рдорд╛рдБ рджреБрд░реНрдЧрд╛", "рдкреВрдирдо рд▓реЗрдбрд┐рдЬ рдХреЙрд░реНрдирд░", "рдЖрдзреБрдирд┐рдХ рд╢реВрдЬ", "рдкреВрдЬрд╛ рд▓реЗрдбрд┐рдЬ рдХреЙрд░реНрдирд░", 
    "рдЧреБрдкреНрддрд╛ рд╕реНрд╡реАрдЯреНрд╕", "рдЬрдп рдЕрдВрдмреЗ рд╕реНрдЯреЛрд░", "рд░рд╛рдЬ рдореЛрдмрд╛рдЗрд▓", "рдиреНрдпреВ рдлреИрд╢рди", 
    "рдУрдо рдЬреНрд╡реЗрд▓рд░реНрд╕", "рд╢рд┐рд╡рдо рд╣рд╛рд░реНрдбрд╡реЗрдпрд░", "рд▓рдХреНрд╖реНрдореА рдЧрд╛рд░рдореЗрдВрдЯреНрд╕", "рд╕рд╛рд╣рд┐рд▓ рдХрд┐рд░рд╛рдирд╛",
    "рдХреГрд╖реНрдгрд╛ рдореЗрдбрд┐рдХрд▓", "рд╕реЛрдиреА рдЗрд▓реЗрдХреНрдЯреНрд░реЙрдирд┐рдХреНрд╕", "рдЕрдорди рд╕реНрдЯреЗрд╢рдирд░реА", "рд╡рд░реНрдорд╛ рдЯреА рд╕реНрдЯрд╛рд▓",
    "рдЦреБрд╢рдмреВ рдмреНрдпреВрдЯреА рдкрд╛рд░реНрд▓рд░", "рд░рд╡рд┐ рд░рд┐рдкреЗрдпрд░рд┐рдВрдЧ", "рдЕрдВрдХрд┐рдд рдЬрдирд░рд▓ рд╕реНрдЯреЛрд░", "рд╕рд░рдХрд╛рд░реА рдореАрдЯрд░"
]

# --- 1. DASHBOARD (The King's View) ---
def show_dashboard():
    st.title("ЁЯУК рдорд┐рд╢реНрд░рд╛ рдорд╛рд░реНрдХреЗрдЯ рдбрд┐рдЬрд┐рдЯрд▓ рд╣реЗрдбрдХреНрд╡рд╛рдЯрд░")
    
    # рд╕рд░рдХрд╛рд░реА рдмрд┐рд▓ рдСрдбрд┐рдЯ (GOVT_BILL_DATA)
    st.subheader("тЪб рд╕рд░рдХрд╛рд░реА рдмрд┐рд▓ рдПрд╡рдВ рдСрдбрд┐рдЯ")
    g_total, g_extra = 5938.00, 3979.06
    kul_rashi = g_total + g_extra # тВ╣9,917.06
    
    gov1, gov2, gov3, gov4, gov5 = st.columns(5)
    gov1.metric("Govt_Bill_Unit", "792")
    gov2.metric("Govt_Extra_Charges", f"тВ╣{g_extra}")
    gov3.metric("рдХреБрд▓ рд╕рд░рдХрд╛рд░реА рд░рд╛рд╢рд┐", f"тВ╣{kul_rashi:.2f}")
    gov4.metric("Govt_Difference_Unit", "176 Units", delta="-Loss", delta_color="inverse")
    gov5.metric("рдбреНрдпреВ рдбреЗрдЯ (Col J)", "07/02/2026")

    st.markdown("---")
    
    # рдорд╛рд░реНрдХреЗрдЯ рд░рд┐рдХрд╡рд░реА (SHOP_DATA)
    st.subheader("ЁЯПв рдорд╛рд░реНрдХреЗрдЯ рд░рд┐рдХрд╡рд░реА рд╕рд╛рд░рд╛рдВрд╢")
    s1, s2, s3 = st.columns(3)
    s1.metric("рдХреБрд▓ рдХрд░рдВрдЯ рдмрд┐рд▓", "тВ╣9,934.24")
    s2.metric("Total_Payable_Amount", "тВ╣48,522", delta="рдмрдХрд╛рдпрд╛ рд╕рд╣рд┐рдд")
    
    paid_amt, pending_amt = 15000, 48522 - 15000
    s3.metric("рдмрд╛рдХреА рд╡рд╕реВрд▓реА (Pending)", f"тВ╣{pending_amt}")
    
    chart_data = pd.DataFrame({'Status': ['Paid', 'Pending'], 'Amount': [paid_amt, pending_amt]})
    st.bar_chart(chart_data.set_index('Status'))

# --- 2. READING ENTRY (Column E рд╕реЗ Prev_Reading) ---
def show_reading_entry():
    st.header("ЁЯЦЛя╕П рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА (SHOP_DATA)")
    shop = st.selectbox("рджреБрдХрд╛рди рдЪреБрдиреЗрдВ", SHOPS)
    
    # рд▓реЙрдЬрд┐рдХ: Prev_Reading рдЕрдм Column E рд╕реЗ рдЖрдПрдЧреА (рдпрд╣рд╛рдБ рдЕрднреА 9000 рдбрдореА рд╣реИ)
    c1, c2 = st.columns(2)
    prev_r = c1.number_input("рдкрд┐рдЫрд▓реА рд░реАрдбрд┐рдВрдЧ (Column E)", value=9000, help="рдпрд╣ рдбреЗрдЯрд╛ Column E рд╕реЗ рдЙрдард╛рдпрд╛ рдЧрдпрд╛ рд╣реИ")
    curr_r = c2.number_input("рдирдИ рд░реАрдбрд┐рдВрдЧ (Current)")
    
    if st.button("Generate Bill & WhatsApp"):
        if curr_r >= prev_r:
            units = curr_r - prev_r
            bill = (units * 9.64) + 222
            st.success(f"рдмрд┐рд▓ рддреИрдпрд╛рд░! рдХреБрд▓ рд░рд╛рд╢рд┐: тВ╣{bill}")
            msg = f"*рдорд┐рд╢реНрд░рд╛ рдорд╛рд░реНрдХреЗрдЯ*\nрджреБрдХрд╛рди: {shop}\nрдпреВрдирд┐рдЯ: {units}\nрдХреБрд▓ рдмрд┐рд▓: тВ╣{bill}"
            st.markdown(f"[ЁЯУ▓ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рднреЗрдЬреЗрдВ](https://wa.me/919936931904?text={urllib.parse.quote(msg)})")
        else:
            st.error("рдХрд░рдВрдЯ рд░реАрдбрд┐рдВрдЧ рдХрдо рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреА!")

# --- 3. PAYMENT LEDGER (Drop-down Fix) ---
def show_payments():
    st.header("ЁЯТ╕ рдкреЗрдореЗрдВрдЯ рд▓реЗрдЬрд░ рдФрд░ рд╡рд╕реВрд▓реА")
    # рдпрд╣рд╛рдБ рдЕрдм рдкреВрд░реА рд╢реЙрдк рд▓рд┐рд╕реНрдЯ рдЖрдПрдЧреА
    shop = st.selectbox("рджреБрдХрд╛рди рдХрд╛ рдирд╛рдо рдЪреБрдиреЗрдВ (рд╡рд╕реВрд▓реА)", SHOPS)
    st.info(f"{shop} рд╕реЗ рдХреБрд▓ рд╡рд╕реВрд▓рдирд╛ рд╣реИ: тВ╣48,522 (рдмрдХрд╛рдпрд╛ рд╕рд╣рд┐рдд рдбреЗрдЯрд╛)")
    
    amt = st.number_input("рдкреНрд░рд╛рдкреНрдд рд░рд╛рд╢рд┐ (Received)")
    mode = st.radio("рдкреЗрдореЗрдВрдЯ рдореЛрдб", ["CASH", "ONLINE"])
    
    if st.button("рдкреЗрдореЗрдВрдЯ рд╕реЗрд╡ рдХрд░реЗрдВ"):
        st.success(f"рд░рд╕реАрдж рддреИрдпрд╛рд░! рдмрдХрд╛рдпрд╛ рдЕрдЧрд▓реЗ рдорд╣реАрдиреЗ рдХреЗ Pending рдореЗрдВ рдЬреБреЬ рдЬрд╛рдПрдЧрд╛ред")

# --- 4. MONTH CLOSE ---
def show_month_close():
    st.header("тЪЩя╕П рдХреНрд▓реЛрдЬ рдордВрде (Carry Forward)")
    if st.button("ЁЯФ┤ CONFIRM MONTH CLOSE"):
        st.balloons()
        st.success("рдбреЗрдЯрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд! Current Reading рдЕрдм Column E (Prev) рдореЗрдВ рд╢рд┐рдлреНрдЯ рд╣реЛ рдЧрдИ рд╣реИред")

# --- MAIN MENU CONTROL ---
st.sidebar.title("ЁЯСС рдореЗрдиреВ")
choice = st.sidebar.radio("рдХрд╣рд╛рдБ рдЬрд╛рдирд╛ рд╣реИ?", ["ЁЯУК рдбреИрд╢рдмреЛрд░реНрдб", "ЁЯЦЛя╕П рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА", "ЁЯТ╕ рдкреЗрдореЗрдВрдЯ рд╡рд╕реВрд▓реА", "тЪЩя╕П рдордВрде рдХреНрд▓реЛрдЬ"])

if choice == "ЁЯУК рдбреИрд╢рдмреЛрд░реНрдб": show_dashboard()
elif choice == "ЁЯЦЛя╕П рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА": show_reading_entry()
elif choice == "ЁЯТ╕ рдкреЗрдореЗрдВрдЯ рд╡рд╕реВрд▓реА": show_payments()
elif choice == "тЪЩя╕П рдордВрде рдХреНрд▓реЛрдЬ": show_month_close()
