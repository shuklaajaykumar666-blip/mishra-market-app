import streamlit as st
import pandas as pd
import urllib.parse

# --- 1. рдРрдк рдХреА рд╕реЗрдЯрд┐рдВрдЧ ---
st.set_page_config(page_title="Mishra Market Admin", layout="wide")

# --- 2. рдЖрдкрдХрд╛ рдЕрд╕рд▓реА рдбреЗрдЯрд╛ (SHOP_DATA) ---
# рдЬрдм рдЖрдк рд╢реАрдЯ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВрдЧреЗ, рддреЛ рдпреЗ рдбреЗрдЯрд╛ рд╕реАрдзреЗ рд╡рд╣рд╛рдБ рд╕реЗ рдЖрдПрдЧрд╛
def get_market_data():
    columns = ["Shop_Name", "WhatsApp No", "Prev_Reading", "Curr_Reading", "Units_Used", "Effective_Unit_Rate", "Fix_Charge", "Current_Bill", "Pending Balance", "Total_Amount", "Status"]
    # рдпрд╣рд╛рдБ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЖрдкрдХреА рджреБрдХрд╛рдиреЛрдВ рдХрд╛ рдбреЗрдЯрд╛ рд╣реИ
    data = [
        ["рдорд╛рдБ рджреБрд░реНрдЧрд╛", "919936xxxx", 9002, 9050, 48, 9.64, 222, 684.72, 0, 684.72, "Paid тЬЕ"],
        ["рдкреВрдирдо рд▓реЗрдбрд┐рдЬ", "919936xxxx", 791, 850, 59, 9.64, 222, 790.76, 500, 1290.76, "Pending тЭМ"],
        ["рд╕рд░рдХрд╛рд░реА рдореАрдЯрд░", "N/A", 594, 770, 176, 0, 0, 0, 5228, 5228, "Loss Area"],
        ["рдкреВрдЬрд╛ рд▓реЗрдбрд┐рдЬ", "919936xxxx", 653, 710, 57, 9.64, 222, 771.48, 1088, 1859.48, "Pending тЭМ"],
    ]
    return pd.DataFrame(data, columns=columns)

# --- 3. рдореЗрдиреВ ---
st.sidebar.title("ЁЯСС рдПрдбрдорд┐рди рдХрдВрдЯреНрд░реЛрд▓")
choice = st.sidebar.radio("рдореЗрдиреБ рдЪреБрдиреЗрдВ", ["ЁЯУЛ рдкреВрд░реА рд╢реЙрдк рд▓рд┐рд╕реНрдЯ (Live Sheet)", "ЁЯЦЛя╕П рдирдИ рд░реАрдбрд┐рдВрдЧ рднрд░реЗрдВ", "ЁЯУК рд╕рд░рдХрд╛рд░реА рдСрдбрд┐рдЯ"])

# --- 4. рдкреВрд░реА рд╢реЙрдк рд▓рд┐рд╕реНрдЯ (рдпрд╣реА рдЖрдкрдХреЛ рдЪрд╛рд╣рд┐рдП рдерд╛) ---
if choice == "ЁЯУЛ рдкреВрд░реА рд╢реЙрдк рд▓рд┐рд╕реНрдЯ (Live Sheet)":
    st.title("ЁЯУЛ рдорд┐рд╢реНрд░рд╛ рдорд╛рд░реНрдХреЗрдЯ - рд▓рд╛рдЗрд╡ рд░рдЬрд┐рд╕реНрдЯрд░")
    st.write("рдпрд╣рд╛рдБ рдЖрдкрдХреА рд╢реАрдЯ рдХрд╛ рдкреВрд░рд╛ рдбреЗрдЯрд╛ рд╣реИ (Row 1 рд╕реЗ Status рддрдХ):")
    
    df = get_market_data()
    
    # рд╕рд░реНрдЪ рдмрд╛рд░ - рдХрд┐рд╕реА рднреА рджреБрдХрд╛рди рдХреЛ рдвреВрдВрдврдиреЗ рдХреЗ рд▓рд┐рдП
    search = st.text_input("ЁЯФН рджреБрдХрд╛рди рдХрд╛ рдирд╛рдо рд▓рд┐рдЦрдХрд░ рдЦреЛрдЬреЗрдВ (Search)...")
    if search:
        df = df[df['Shop_Name'].str.contains(search, case=False)]
    
    # рдкреВрд░реА рдЯреЗрдмрд▓ рджрд┐рдЦрд╛рдирд╛
    st.dataframe(df.style.highlight_max(axis=0, subset=['Total_Amount'], color='#ffcccc'), use_container_width=True)
    
    st.info("ЁЯТб рдЯрд┐рдк: рдКрдкрд░ рдЯреЗрдмрд▓ рдореЗрдВ рдХрд┐рд╕реА рднреА рдХреЙрд▓рдо рдХреЗ рдирд╛рдо рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ рдЖрдк рдЙрд╕реЗ рдЫреЛрдЯрд╛-рдмрдбрд╝рд╛ рдпрд╛ рдКрдкрд░-рдиреАрдЪреЗ (Sort) рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред")

# --- 5. рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА ---
elif choice == "ЁЯЦЛя╕П рдирдИ рд░реАрдбрд┐рдВрдЧ рднрд░реЗрдВ":
    st.header("ЁЯЦЛя╕П рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА (Direct Entry to Sheet)")
    df = get_market_data()
    shop = st.selectbox("рджреБрдХрд╛рди рдЪреБрдиреЗрдВ", df['Shop_Name'].tolist())
    
    # Column C (Prev_Reading) рдЙрдард╛рдирд╛
    prev_r = df[df['Shop_Name'] == shop]['Prev_Reading'].values[0]
    
    c1, c2 = st.columns(2)
    c1.metric("рдкрд┐рдЫрд▓реА рд░реАрдбрд┐рдВрдЧ (Col C)", prev_r)
    curr_r = c2.number_input("рдирдИ рд░реАрдбрд┐рдВрдЧ рджрд░реНрдЬ рдХрд░реЗрдВ", min_value=float(prev_r))
    
    if st.button("WhatsApp рдмрд┐рд▓ рддреИрдпрд╛рд░ рдХрд░реЗрдВ"):
        st.success("рдбрд╛рдЯрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд! рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рд▓рд┐рдВрдХ рдиреАрдЪреЗ рд╣реИред")

# --- 6. рд╕рд░рдХрд╛рд░реА рдСрдбрд┐рдЯ ---
elif choice == "ЁЯУК рд╕рд░рдХрд╛рд░реА рдСрдбрд┐рдЯ":
    st.title("ЁЯУК рд╕рд░рдХрд╛рд░реА рдмрд┐рд▓ рдФрд░ рд░рд┐рдХрд╡рд░реА")
    st.metric("Total Payable (Col J)", "тВ╣48,522", delta="рдорд╛рд░реНрдХреЗрдЯ рдХрд╛ рдХреБрд▓ рдмрдХрд╛рдпрд╛")
