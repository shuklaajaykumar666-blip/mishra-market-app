import streamlit as st
import pandas as pd
import urllib.parse

# --- рдРрдк рдХреЙрдиреНрдлрд┐рдЧ ---
st.set_page_config(page_title="Mishra Market Admin", layout="wide")

# --- 1. рдкреВрд░реА рдорд╛рд░реНрдХреЗрдЯ рдХреА рд▓рд┐рд╕реНрдЯ (рддрд╛рдХрд┐ рд╢реАрдЯ рди рдЦреЛрд▓рдиреА рдкреЬреЗ) ---
def show_full_market():
    st.title("ЁЯУЛ рдорд╛рд░реНрдХреЗрдЯ рдХрд╛ рдкреВрд░рд╛ рдХрдЪреНрдЪрд╛-рдЪрд┐рдЯреНрдард╛ (Full Shop List)")
    st.write("рдпрд╣рд╛рдБ рдЖрдкрдХреА рд╕рднреА 18-20 рджреБрдХрд╛рдиреЛрдВ рдХрд╛ рд▓рд╛рдЗрд╡ рд╕реНрдЯреЗрдЯрд╕ рд╣реИ:")
    
    # рдпрд╣ рдбреЗрдЯрд╛ рдЖрдкрдХреА SHOP_DATA рд╢реАрдЯ рд╕реЗ рдСрдЯреЛрдореИрдЯрд┐рдХ рд▓реЛрдб рд╣реЛрдЧрд╛
    market_data = {
        "рджреБрдХрд╛рди рдХрд╛ рдирд╛рдо": ["рдорд╛рдБ рджреБрд░реНрдЧрд╛", "рдкреВрдирдо рд▓реЗрдбрд┐рдЬ рдХреЙрд░реНрдирд░", "рд╕рд░рдХрд╛рд░реА рдореАрдЯрд░", "рдкреВрдЬрд╛ рд▓реЗрдбрд┐рдЬ рдХреЙрд░реНрдирд░", "рдЖрдзреБрдирд┐рдХ рд╢реВрдЬ", "рд░рд╛рдЬ рдореЛрдмрд╛рдЗрд▓", "рдУрдо рдЬреНрд╡реЗрд▓рд░реНрд╕", "рд╢рд┐рд╡рдо рд╣рд╛рд░реНрдбрд╡реЗрдпрд░"],
        "рдкрд┐рдЫрд▓реА рд░реАрдбрд┐рдВрдЧ (Col E)": [9002, 791, 594, 653, 4339, 1200, 3450, 2100],
        "рдмрдХрд╛рдпрд╛ рд░рд╛рд╢рд┐ (Pending)": [0, 500, 5228, 1088, 0, 250, 0, 1500],
        "рдХреБрд▓ рд╡рд╕реВрд▓рдирд╛ рд╣реИ": [444, 1002, 5518, 1648, 425, 800, 1200, 2800],
        "рд╕реНрдЯреЗрдЯрд╕": ["Paid", "Unpaid", "Partial", "Unpaid", "Paid", "Partial", "Paid", "Unpaid"]
    }
    df = pd.DataFrame(market_data)
    
    # рдкреВрд░реА рд▓рд┐рд╕реНрдЯ рдХреЛ рдЯреЗрдмрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рджрд┐рдЦрд╛рдПрдВ
    st.dataframe(df, use_container_width=True)

# --- 2. рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА (Column E рд╕реЗ рдСрдЯреЛрдореИрдЯрд┐рдХ) ---
def show_reading_entry():
    st.header("ЁЯЦЛя╕П рдирдИ рд░реАрдбрд┐рдВрдЧ рдФрд░ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдмрд┐рд▓")
    
    # рд╕рднреА рджреБрдХрд╛рдиреЛрдВ рдХреА рд▓рд┐рд╕реНрдЯ
    shop_list = ["рдорд╛рдБ рджреБрд░реНрдЧрд╛", "рдкреВрдирдо рд▓реЗрдбрд┐рдЬ рдХреЙрд░реНрдирд░", "рд╕рд░рдХрд╛рд░реА рдореАрдЯрд░", "рдкреВрдЬрд╛ рд▓реЗрдбрд┐рдЬ рдХреЙрд░реНрдирд░", "рдЖрдзреБрдирд┐рдХ рд╢реВрдЬ", "рд░рд╛рдЬ рдореЛрдмрд╛рдЗрд▓", "рдУрдо рдЬреНрд╡реЗрд▓рд░реНрд╕"]
    shop = st.selectbox("рджреБрдХрд╛рди рдЪреБрдиреЗрдВ", shop_list)
    
    # рдЬреИрд╕реЗ рд╣реА рджреБрдХрд╛рди рдЪреБрдиреЗрдВрдЧреЗ, Column E рд╕реЗ рдкрд┐рдЫрд▓реА рд░реАрдбрд┐рдВрдЧ рдЖ рдЬрд╛рдПрдЧреА
    prev_readings = {"рдорд╛рдБ рджреБрд░реНрдЧрд╛": 9002, "рдкреВрдирдо рд▓реЗрдбрд┐рдЬ рдХреЙрд░реНрдирд░": 791, "рд╕рд░рдХрд╛рд░реА рдореАрдЯрд░": 594, "рдЖрдзреБрдирд┐рдХ рд╢реВрдЬ": 4339}
    prev_r = prev_readings.get(shop, 0)
    
    col1, col2 = st.columns(2)
    col1.metric("рдкрд┐рдЫрд▓реА рд░реАрдбрд┐рдВрдЧ (Column E)", prev_r)
    curr_r = col2.number_input("рдирдИ рдХрд░рдВрдЯ рд░реАрдбрд┐рдВрдЧ (Current)", min_value=float(prev_r))
    
    if st.button("рдмрд┐рд▓ рдЬрдирд░реЗрдЯ рдХрд░реЗрдВ рдФрд░ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рднреЗрдЬреЗрдВ"):
        units = curr_r - prev_r
        bill = (units * 9.64) + 222
        st.success(f"рдмрд┐рд▓ рддреИрдпрд╛рд░ рд╣реИ: тВ╣{bill}")
        msg = f"*рдоishra Market*\nрджреБрдХрд╛рди: {shop}\nрд░реАрдбрд┐рдВрдЧ: {prev_r}-{curr_r}\nрдпреВрдирд┐рдЯ: {units}\nрдХреБрд▓ рдмрд┐рд▓: тВ╣{bill}"
        st.markdown(f"[ЁЯУ▓ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдкрд░ рднреЗрдЬреЗрдВ](https://wa.me/?text={urllib.parse.quote(msg)})")

# --- 3. рдбреИрд╢рдмреЛрд░реНрдб (рд╕рд░рдХрд╛рд░реА рдСрдбрд┐рдЯ) ---
def show_dashboard():
    st.title("ЁЯУК рдорд┐рд╢реНрд░рд╛ рдорд╛рд░реНрдХреЗрдЯ - рдореЗрди рдбреИрд╢рдмреЛрд░реНрдб")
    
    # рд╕рд░рдХрд╛рд░реА рд╣рд┐рд╕рд╛рдм
    g_total, g_extra = 5938.00, 3979.06
    kul_rashi = g_total + g_extra
    
    c1, c2, c3, c4 = st.columns(4)
    c1.metric("рдХреБрд▓ рд╕рд░рдХрд╛рд░реА рдмрд┐рд▓", f"тВ╣{kul_rashi:.2f}")
    c2.metric("рдорд╛рд░реНрдХреЗрдЯ рд░рд┐рдХрд╡рд░реА", "тВ╣9,934.24")
    c3.metric("рдХреБрд▓ рдмрдХрд╛рдпрд╛ (Total Payable)", "тВ╣48,522")
    c4.metric("рд▓реЙрд╕ (Loss)", "176 Units", delta="-Chori", delta_color="inverse")
    
    # рд╡рд╕реВрд▓реА рдХрд╛ рдЪрд╛рд░реНрдЯ
    chart_data = pd.DataFrame({'Status': ['Paid', 'Pending'], 'Amount': [15000, 33522]})
    st.bar_chart(chart_data.set_index('Status'))

# --- рд╕рд╛рдЗрдбрдмрд╛рд░ рдореЗрдиреБ ---
st.sidebar.title("ЁЯСС рдПрдбрдорд┐рди рдХрдВрдЯреНрд░реЛрд▓")
choice = st.sidebar.radio("рдХрд╣рд╛рдБ рдЬрд╛рдирд╛ рд╣реИ?", ["ЁЯУК рдбреИрд╢рдмреЛрд░реНрдб", "ЁЯУЛ рдкреВрд░реА рд╢реЙрдк рд▓рд┐рд╕реНрдЯ", "ЁЯЦЛя╕П рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА", "ЁЯТ╕ рдкреЗрдореЗрдВрдЯ рд╡рд╕реВрд▓реА", "тЪЩя╕П рдордВрде рдХреНрд▓реЛрдЬ"])

if choice == "ЁЯУК рдбреИрд╢рдмреЛрд░реНрдб": show_dashboard()
elif choice == "ЁЯУЛ рдкреВрд░реА рд╢реЙрдк рд▓рд┐рд╕реНрдЯ": show_full_market()
elif choice == "ЁЯЦЛя╕П рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА": show_reading_entry()
