import streamlit as st
import pandas as pd
import urllib.parse

# --- APP CONFIG ---
st.set_page_config(page_title="Mishra Market Admin", layout="wide")

# --- SIDEBAR MENU (рдЕрдм рдпреЗ 100% рд╕рд╣реА рдХрд╛рдо рдХрд░реЗрдЧрд╛) ---
st.sidebar.title("ЁЯСС рдХрдВрдЯреНрд░реЛрд▓ рдкреИрдирд▓")
choice = st.sidebar.radio("рдореЗрдиреБ рдЪреБрдиреЗрдВ", ["ЁЯУК рдбреИрд╢рдмреЛрд░реНрдб", "ЁЯЦЛя╕П рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА", "ЁЯТ╕ рдкреЗрдореЗрдВрдЯ рд╡рд╕реВрд▓реА", "тЪЩя╕П рдордВрде рдХреНрд▓реЛрдЬ"])

# --- 1. рдбреИрд╢рдмреЛрд░реНрдб (The King's Dashboard) ---
if choice == "ЁЯУК рдбреИрд╢рдмреЛрд░реНрдб":
    st.title("ЁЯУК рдорд┐рд╢реНрд░рд╛ рдорд╛рд░реНрдХреЗрдЯ рдбрд┐рдЬрд┐рдЯрд▓ рд╣реЗрдбрдХреНрд╡рд╛рдЯрд░")
    
    # рд╕рд░рдХрд╛рд░реА рдмрд┐рд▓ (GOVT_BILL_DATA) - рдЖрдкрдХрд╛ рд╕рдЯреАрдХ рдЧрдгрд┐рдд
    st.subheader("тЪб рд╕рд░рдХрд╛рд░реА рдмрд┐рд▓ рдПрд╡рдВ рдСрдбрд┐рдЯ")
    g_total = 5938.00
    g_extra = 3979.06
    kul_rashi = g_total + g_extra # тВ╣9,917.06
    
    gov1, gov2, gov3, gov4, gov5 = st.columns(5)
    gov1.metric("Govt_Bill_Unit", "792")
    gov2.metric("Govt_Extra_Charges", f"тВ╣{g_extra}")
    gov3.metric("рдХреБрд▓ рд╕рд░рдХрд╛рд░реА рд░рд╛рд╢рд┐", f"тВ╣{kul_rashi:.2f}")
    gov4.metric("Govt_Difference_Unit", "176 Units", delta="-Loss", delta_color="inverse")
    gov5.metric("рдбреНрдпреВ рдбреЗрдЯ (Col J)", "07/02/2026")

    st.markdown("---")

    # рдорд╛рд░реНрдХреЗрдЯ рд░рд┐рдХрд╡рд░реА (SHOP_DATA)
    st.subheader("ЁЯПв рдорд╛рд░реНрдХреЗрдЯ рд░рд┐рдХрд╡рд░реА рд╕рд╛рд░рд╛рдВрд╢")
    s1, s2, s3 = st.columns(3)
    s1.metric("рдХреБрд▓ рдХрд░рдВрдЯ рдмрд┐рд▓", "тВ╣9,934.24")
    s2.metric("Total_Payable_Amount", "тВ╣48,522", delta="рдмрдХрд╛рдпрд╛ рд╕рд╣рд┐рдд")
    
    # рдЪрд╛рд░реНрдЯ рд╡рд╛рд▓рд╛ рд╣рд┐рд╕реНрд╕рд╛ (Paid vs Pending)
    paid_amt = 15000 
    pending_amt = 48522 - paid_amt
    s3.metric("рдмрд╛рдХреА рд╡рд╕реВрд▓реА (Pending)", f"тВ╣{pending_amt}")
    
    chart_data = pd.DataFrame({'Status': ['Paid', 'Pending'], 'Amount': [paid_amt, pending_amt]})
    st.bar_chart(chart_data.set_index('Status'))

# --- 2. рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА (The Reading System) ---
elif choice == "ЁЯЦЛя╕П рд░реАрдбрд┐рдВрдЧ рдПрдВрдЯреНрд░реА":
    st.header("ЁЯЦЛя╕П рд░реАрдбрд┐рдВрдЧ рдФрд░ рдмрд┐рд▓ рдЬрдирд░реЗрд╢рди")
    shop = st.selectbox("рджреБрдХрд╛рди рдЪреБрдиреЗрдВ", ["рдорд╛рдБ рджреБрд░реНрдЧрд╛", "рдкреВрдирдо рд▓реЗрдбрд┐рдЬ рдХреЙрд░реНрдирд░", "рдЖрдзреБрдирд┐рдХ рд╢реВрдЬ"])
    
    c1, c2 = st.columns(2)
    prev_r = c1.number_input("рдкрд┐рдЫрд▓реА рд░реАрдбрд┐рдВрдЧ (Prev)", value=9000)
    curr_r = c2.number_input("рдирдИ рд░реАрдбрд┐рдВрдЧ (Current)", min_value=0)
    
    if st.button("Generate & WhatsApp"):
        if curr_r >= prev_r:
            units = curr_r - prev_r
            bill = (units * 9.64) + 222
            st.success(f"рдмрд┐рд▓ рддреИрдпрд╛рд░: тВ╣{bill}")
            msg = f"*рдорд┐рд╢реНрд░рд╛ рдорд╛рд░реНрдХреЗрдЯ*\nрджреБрдХрд╛рди: {shop}\nрдпреВрдирд┐рдЯ: {units}\nрдмрд┐рд▓: тВ╣{bill}"
            st.markdown(f"[ЁЯУ▓ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рднреЗрдЬреЗрдВ](https://wa.me/919936931904?text={urllib.parse.quote(msg)})")
        else:
            st.error("рдХрд░рдВрдЯ рд░реАрдбрд┐рдВрдЧ рдкрд┐рдЫрд▓реА рд░реАрдбрд┐рдВрдЧ рд╕реЗ рдХрдо рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреА!")

# --- 3. рдкреЗрдореЗрдВрдЯ рд▓реЗрдЬрд░ (The Payment Recovery) ---
elif choice == "ЁЯТ╕ рдкреЗрдореЗрдВрдЯ рд╡рд╕реВрд▓реА":
    st.header("ЁЯТ╕ рдкреЗрдореЗрдВрдЯ рд▓реЗрдЬрд░ рдФрд░ рд░рд╕реАрдж")
    shop = st.selectbox("рджреБрдХрд╛рди рдХрд╛ рдирд╛рдо рдЪреБрдиреЗрдВ", ["рдорд╛рдБ рджреБрд░реНрдЧрд╛", "рдкреВрдирдо рд▓реЗрдбрд┐рдЬ рдХреЙрд░реНрдирд░"])
    st.info("рдХреБрд▓ рд╡рд╕реВрд▓рдирд╛ рд╣реИ: тВ╣48,522 (рдмрдХрд╛рдпрд╛ рд╕рд╣рд┐рдд)")
    
    amt = st.number_input("рдкреНрд░рд╛рдкреНрдд рд░рд╛рд╢рд┐")
    mode = st.radio("рдкреЗрдореЗрдВрдЯ рдореЛрдб", ["CASH", "ONLINE"])
    
    if st.button("рдкреЗрдореЗрдВрдЯ рджрд░реНрдЬ рдХрд░реЗрдВ"):
        st.success(f"тВ╣{amt} рдкреНрд░рд╛рдкреНрдд! рд╕реНрдЯреЗрдЯрд╕ рдЕрдкрдбреЗрдЯ рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред")

# --- 4. рдордВрде рдХреНрд▓реЛрдЬ (The Carry Forward Tool) ---
elif choice == "тЪЩя╕П рдордВрде рдХреНрд▓реЛрдЬ":
    st.header("тЪЩя╕П рдХреНрд▓реЛрдЬ рдордВрде (Carry Forward)")
    st.error("рд╕рд╛рд╡рдзрд╛рди: рдпрд╣ рдмрдЯрди рд╕рд╛рд░рд╛ рдбреЗрдЯрд╛ Row 11 рдХреЗ рдиреАрдЪреЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░ рджреЗрдЧрд╛ред")
    if st.button("ЁЯФ┤ CONFIRM MONTH CLOSE"):
        st.balloons()
        st.success("рдЗрддрд┐рд╣рд╛рд╕ (History) рдЯреИрдм рдореЗрдВ рдбреЗрдЯрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реЛ рдЧрдпрд╛ред")
